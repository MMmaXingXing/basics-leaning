# 从 URL 输入到页面展示究竟发生了什么

## 流程

- 输入 Url
- 请求资源
- 渲染页面

## 输入 URL

- 进行 url 补充
- 请求资源
- 资源渲染成页面

## 请求资源

请求资源时，浏览器进程会将 URL 发送到网络进程。网络进程进行资源请求。网络进程会做：

### 查询缓存资源

查询本地缓存是否缓存了该资源，有的话直接返回资源给浏览器进程，如果没有则进行下一步。

### 网络请求流程

#### 客户端

- DNS 解析域名 IP 地址，HTTPS 进行 TLS 连接
- TCP/IP 3 次握手，建立与服务器连接
- 构建 HTTP 响应报文并发送

#### 服务端

解析响应报文：

- 重定向：301、302 发起新的请求
- 根据响应头 Content- Type 字段渲染，如果该字段为 text/html 则会进入渲染流程

### 渲染

在接收到响应报文后，网络进程会通知浏览器进程。浏览器进程会做：

1. 根据域名分配渲染进程（主域名相同的为同一进程）
2. 对渲染进程发起`提交文档`信息
3. 渲染进程接收到后与网络进程建立传输管道，传输数据
4. 传输完成后，渲染进程向浏览器进程返回 `确认提交`的消息
5. 浏览器进程在收到`确认提交`的消息后，会更新浏览器界面状态（安全状态、地址栏的 URI、前进后退的历史状态，并更新 Web 页面）

### 渲染流水线

按照渲染的时间，分为如下几个阶段

- 构建 DOM 树
- 样式计算
- 布局
- 分层
- 分块
- 光栅化
- 合成

### 构建 DOM 树

浏览器通过 HTML 解析器将 HTML 转换为 DOM 树结构、并存在缓存中。

### 样式计算

- CSS 文本转换为 style Sheets 结构中的数据，该结构同时具备了查询和修改功能。

- 转换样式表中的属性值，使其标准化（如 2em、blue、blod）

- 依据 CSS 继承、样式层叠，计算出 DOM 树中每个节点的具体样式。

此阶段最终输出是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。

### 布局

- 创建布局树

- 布局计算

### 分层

- 层叠上下文被提升为一层
  - 定位属性
  - 透明属性
  - CSS 滤镜
- 需要被裁减 Clip 的部分也会被创建图层。例如：内容溢出

### 图层绘制

绘制一个元素通常需要好几条绘制指令，因为每个元素的背景、前景、边框都需要单独的指令去绘制。为每个图层生成绘制列表，并将其提交到合成线程。
